#!/usr/bin/env python


# Author: javiervidrua (javiervidrua)
# Year: 2020
# Site: https://javiervidrua.github.io
# Credits: The other authors
# About: Transformed the library from phillips321
#  and jbertman into a tool to make buffer overflow
#  exploit development a litlle bit easier
########################################################


import sys, os, getopt, struct


# ========= #
# FUNCTIONS #
# ========= #
def interactive():
    # 1 - Create the pattern
    print( pattern_create( int(raw_input('[*] Pattern lenght: ')) )+'\n')

    # 2 - Get the offset
    offset = raw_input('[*] Enter the offset (4 bytes): ')
    offset = ('0x'+offset if '0x' not in offset else offset)
    # if '0x' not in offset:
    #     offset = '0x' + offset

    # offset = '69413269' # For debugging purposes
    offset = pattern_offset(offset)
    if offset == -1:
        # Now it would be a great time to think of a way to implement pattern_offset by using the line I have bellow
        #print reverse('69413269'.decode('hex')) # Reverse because it is little endian, decode.('hex') because the input value is in hexadecimal
        print '[-] Error: pattern_offset: Could not find the correct offset'
        sys.exit(1)

    print '[*] The offset is: %i\n' %offset

    # 3 - Get the badchars
    print '[*] Printing badchars ready to paste on Python code'
    print """badchars=(\"\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\"
\"\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\"
\"\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\"
\"\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\"
\"\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\"
\"\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\"
\"\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\"
\"\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\"
\"\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\"
\"\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\"
\"\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\"
\"\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\"
\"\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\"
\"\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\"
\"\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\"
\"\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\")\n"""
    # https://github.com/fishstiqz/nasmshell


# Author: phillips321
# Site: www.phillips321.co.uk
# Version 0.1
# Credits: metasploit project
# About: Replicates msf pattern_create.rb
########################################################
def pattern_create(length, set_a=None, set_b=None, set_c=None):
    if not isinstance(length, int):
        raise Exception('[-] Length must be an integer')
        sys.exit(1) 

    if not set_a: seta="ABCDEFGHIJKLMNOPQRSTUVWXYZ"
    if not set_b: setb="abcdefghijklmnopqrstuvwxyz"
    if not set_c: setc="0123456789"

    string="" ; a=0 ; b=0 ; c=0
    
    while len(string) < length:
        if not set_a and not set_b and not set_c:
            string += seta[a] + setb[b] + setc[c]
            c+=1
            if c == len(setc):c=0;b+=1
            if b == len(setb):b=0;a+=1
            if a == len(seta):a=0
        elif set_a and not set_b and not set_c:
            raise Exception('[-] Error: pattern_create: Cannot work with just one set!')
            sys.exit(1)
        elif set_a and set_b and not set_c:
            string += seta[a] + setb[b]
            b+=1
            if b == len(setb):b=0;a+=1
            if a == len(seta):a=0
        elif set_a and set_b and set_c:
            string += seta[a] + setb[b] + setc[c]
            c+=1
            if c == len(setc):c=0;b+=1
            if b == len(setb):b=0;a+=1
            if a == len(seta):a=0
        else:
            raise Exception('[-] Error: pattern_create: Input error: Please check your parameters')
            sys.exit(1)

    return string[:length]


# Author: jbertman (nok0)
# Version 0.1
# Credits: Metasploit project
# About: Replicates msf pattern_offset.rb
########################################################
# Author: javiervidrua 2020
# Site: https://javiervidrua.github.io
# Version 0.2
# Credits: jbertman
# About: Fixed some bugs, made it smaller and more clean
########################################################
def pattern_offset(value):
    if len(value) >= 8 and int(value, 16) > 0:
        value = int(value, 16)
    elif len(value) == 4:
        value = struct.unpack('<L', value)[0]
    else:
        value = int(value, 16)

    buf = pattern_create(8192)
    offset = buf.find(struct.pack('<L',value))

    while offset != -1:
        return offset


def reverse(string):
    return string[::-1]


# ==== #
# MAIN #
# ==== #
if __name__ == "__main__":
    interactive()
